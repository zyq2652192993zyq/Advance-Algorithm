> # 数学——蓄水池抽样（Reservoir Sampling）

参考链接：<https://www.cnblogs.com/snowInPluto/p/5996269.html>

编程珠玑：<https://blog.csdn.net/huagong_adu/article/details/7619665>

https://zhuanlan.zhihu.com/p/32845748

## 基础知识

### 从n个不同的数字等概率的抽取k个不重复的数字

假设现在有`0, 1, 2 ... n - 1`共`n`个数字，从中不重复的抽取`k`个数字。

```c++
vector<int> sample(int n, int k) {
    vector<int> res(k);
    for (int i = 0; i < n; ++i) {
        int tmp = rand() % n;
        if (tmp < k) {
            int index = res.size() - k;
            res[index] = i;
            --k;
        }
        --n;
    }
    
    return res;
}
```

需要证明：

* 在遍历结束的时候选择了`k`个数字
* 这`n`个数字被选择的概率是等可能的
* 无重复数字（显然无重复）





### 大数据流中的抽样问题

**问题：**如何随机从n个对象中选择一个对象，这n个对象是按序排列的，但是在此之前你是不知道n的值的。

**思路**：如果我们知道n的值，那么问题就可以简单的用一个大随机数rand()%n得到一个确切的随机位置，那么该位置的对象就是所求的对象，选中的概率是1/n。

但现在我们并不知道n的值，这个问题便抽象为蓄水池抽样问题，即从一个包含n个对象的列表S中随机选取k个对象，n为一个非常大或者不知道的值。通常情况下，n是一个非常大的值，大到无法一次性把所有列表S中的对象都放到内存中。我们这个问题是蓄水池抽样问题的一个特例，即k=1。

**解法**：我们总是选择第一个对象，以1/2的概率选择第二个，以1/3的概率选择第三个，以此类推，以1/m的概率选择第m个对象。当该过程结束时，每一个对象具有相同的选中概率，即1/n，证明如下。

**证明**：第m个对象最终被选中的概率P=选择m的概率*其后面所有对象不被选择的概率，即
$$
P = \frac{1}{m} \times \left( \frac{m}{m + 1} \times \frac{m + 1}{m + 2} \cdots \frac{n - 1}{n} \right) = \frac{1}{n}
$$
对于公式的解释：从前往后遍历，遍历到第`m`个元素，相当于目前有`m`个备选项，则选择第`m`个的概率是$\frac{1}{m}$，遍历到第`m + 1`个的时候， 相当于有`m + 1`个备选项，不选择第`m`个的概率是$\frac{m}{m + 1}$。

算法的时间复杂度为$O(n)$，空间复杂度为$O(1)$。

## 典型题目

- [x] LeetCode 382 链表随机节点
- [ ] LeetCode 398 随机数索引
- [ ] LeetCode 497 非重叠矩形中的随机点



